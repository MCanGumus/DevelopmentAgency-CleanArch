@using DA.Controllers
@using DA.Domain.Dtos
@using DA.Domain.Enums
@using DA.Models

@model PermissionsWithHolidays
@{
    Layout = "_Layout";
}

@section scripts {

    <script>

        $(document).ready(function () {
            var dateOfStart = '@Model.StartDate.ToString("yyyy-MM-ddTHH:mm")';
            var dateOfEnd = '@Model.EndDate.ToString("yyyy-MM-ddTHH:mm")';

            $('#DateOfStart').val(dateOfStart);
            $('#DateOfEnd').val(dateOfEnd);

            $("#Listing").click(function () {

                var dateOfStart = $('#DateOfStart').val();
                var dateOfEnd = $('#DateOfEnd').val();

                if (dateOfStart == null || dateOfStart == "") {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini giriniz.");
                    return;
                }

                if (dateOfEnd == null || dateOfEnd == "") {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini giriniz.");
                    return;
                }

                var startDate = new Date(dateOfStart);
                var endDate = new Date(dateOfEnd);

                if (endDate <= startDate) {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini doğru giriniz.");
                    return;
                }


                $('#departureDateOfStart').val(dateOfStart);
                $('#departureDateOfEnd').val(dateOfEnd);

                $.ajax({
                    type: "POST",
                    url: "/" + "PermissionReport/PermissionReportWithFilter",
                    data: { startDate: dateOfStart, endDate: dateOfEnd },
                    success: function (response) {
                        // Handle the response here
                        $('body').html(response); // Render the returned HTML
                    }
                });
            });

            $("#ExportExcel").click(function () {
                var dateOfStart = $('#DateOfStart').val();
                var dateOfEnd = $('#DateOfEnd').val();

                if (dateOfStart == null || dateOfStart == "") {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini giriniz.");
                    return;
                }

                if (dateOfEnd == null || dateOfEnd == "") {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini giriniz.");
                    return;
                }

                var startDate = new Date(dateOfStart);
                var endDate = new Date(dateOfEnd);

                if (endDate <= startDate) {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini doğru giriniz.");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "/" + "PermissionReport/ExcelExportReport",
                    data: { startDate: dateOfStart, endDate: dateOfEnd },
                    success: function (response) {
                        eval(response);
                    }
                });
            });

        });
    </script>
}

<div class="card">
    <div class="card-body">
        <h4 class="card-title">İzin Raporları</h4>
        <hr />
        <div class="row mb-2">
            <div class="col-md-4 row">
                <label for="DateRangeFilter" class="col-sm-4 col-form-label pt-0 bold">Başlama Tarihi</label>
                <div class="col-lg-8 col-md-8 col-sm-7">
                    <input type="datetime-local" id="DateOfStart" class="form-control" style="width: 100%;" />
                </div>
            </div>
            <div class="col-4 row">
                <label for="DateRangeFilter" class="col-sm-4 col-form-label pt-0 bold">Bitiş Tarihi</label>
                <div class="col-lg-8 col-md-8 col-sm-7">
                    <input type="datetime-local" id="DateOfEnd" class="form-control" style="width: 100%;" />
                </div>
            </div>
            <div class="col-2">
                <button id="Listing" class="btn btn-primary mb-4">Listele</button>
            </div>
            <div class="col-2">
                <button id="ExportExcel" class="btn btn-success mb-4">Excel Çıktısı Al</button>
            </div>

        </div>
        <hr />
        <div class="table-responsive">
            <table class="table dataTable table-striped table-hover">
                <thead>
                    <tr>
                        <th>Belge Numarası</th>
                        <th>Çalışan</th>
                        <th>İzin Nedeni</th>
                        <th>İzin Başlangıç Tarihi</th>
                        <th>İşe Başlangıç Tarihi</th>
                        <th>Gün Sayısı</th>
                        <th>Durum</th>
                        <th class="text-center">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Permissions.Count != 0)
                    {
                        List<PublicHolidayDto> phList = Model.Holidays;

                        var holidays = phList;

                        foreach (var item in holidays)
                        {
                            if (item.IsNationalHoliday)
                            {
                                item.Date = new DateTime(DateTime.Now.Year, item.Date.Month, item.Date.Day);
                            }
                        }

                        @foreach (PermissionDto item in Model.Permissions)
                        {

                            int day = 0;

                            for (DateTime date = item.StartDate; date < item.EndDate; date = date.AddDays(1))
                            {
                                if (date.DayOfWeek != DayOfWeek.Saturday && date.DayOfWeek != DayOfWeek.Sunday)
                                {
                                    if (!holidays.Any(x => x.Date == date))
                                    {
                                        day++;
                                    }
                                }
                            }
                           

                            <tr id="@item.Id.ToString()">
                                <td>@item.DocumentId</td>
                                <td>@item.Employee.Name @item.Employee.Surname</td>
                                <td>@item.PermissionReason</td>
                                <td>@item.StartDate.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@item.EndDate.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@day gün</td>
                                <td>@PermissionController.StateTR(item.State)</td>
                                <td>
                                    <a onclick="AjaxMethod('Permissions/OpenDetail', '@item.Id.ToString()', 'OpenDetail')" href=""><i class="mdi mdi-file text-info md20"></i></a>
                                    @if (item.State == EnumState.Pending)
                                    {
                                        <a class="btn btn-success" onclick="AjaxMethod('AllPermissions/Accept', '@item.Id.ToString()', 'AcceptPermission')" href="">Kabul Et</a>
                                        <a class="btn btn-danger" onclick="AjaxMethod('AllPermissions/Reject', '@item.Id.ToString()', 'RejectPermission')" href="">Reddet</a>
                                    }
                                    else if (item.State == EnumState.Accepted)
                                    {
                                        <a onclick="AjaxMethod('Permissions/ExportDocument', '@item.Id.ToString()', 'Print')" href=""><i class="mdi mdi-printer text-warning md20"></i></a>
                                        <a class="btn btn-danger" onclick="AjaxMethod('AllPermissions/Reject', '@item.Id.ToString()', 'RejectPermission')" href="">Reddet</a>
                                    }
                                   
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

        </div>
    </div>
</div>

@Html.Partial("_DetailModal")

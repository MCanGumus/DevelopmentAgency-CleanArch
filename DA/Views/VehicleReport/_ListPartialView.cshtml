@using DA.Domain.Dtos
@using DA.Models

@model VehicleRequestReportModel
@{
    Layout = "_Layout";
}

@section scripts {

    <script>

        $(document).ready(function () {
            // Date range picker initialization
            var dateOfStart = '@Model.StartDate.ToString("yyyy-MM-ddTHH:mm")';
            var dateOfEnd = '@Model.EndDate.ToString("yyyy-MM-ddTHH:mm")';

            $('#DateOfStart').val(dateOfStart);
            $('#DateOfEnd').val(dateOfEnd);

            $("#Listing").click(function () {

                var dateOfStart = $('#DateOfStart').val();
                var dateOfEnd = $('#DateOfEnd').val();

                if (dateOfStart == null || dateOfStart == "") {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini giriniz.");
                    return;
                }

                if (dateOfEnd == null || dateOfEnd == "") {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini giriniz.");
                    return;
                }

                var startDate = new Date(dateOfStart);
                var endDate = new Date(dateOfEnd);

                if (endDate <= startDate) {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini doğru giriniz.");
                    return;
                }


                $('#departureDateOfStart').val(dateOfStart);
                $('#departureDateOfEnd').val(dateOfEnd);

                $.ajax({
                    type: "POST",
                    url: "/" + "VehicleReport/VehicleRequestReportWithFilter",
                    data: { startDate: dateOfStart, endDate: dateOfEnd },
                    success: function (response) {
                        // Handle the response here
                        $('body').html(response); // Render the returned HTML
                    }
                });
            });

            $("#ExportExcel").click(function () {
                var dateOfStart = $('#DateOfStart').val();
                var dateOfEnd = $('#DateOfEnd').val();

                if (dateOfStart == null || dateOfStart == "") {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini giriniz.");
                    return;
                }

                if (dateOfEnd == null || dateOfEnd == "") {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini giriniz.");
                    return;
                }

                var startDate = new Date(dateOfStart);
                var endDate = new Date(dateOfEnd);

                if (endDate <= startDate) {
                    ShowErrorMessage("Lütfen başlama bitiş tarihlerini doğru giriniz.");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "/" + "VehicleReport/ExcelExportReport",
                    data: { startDate: dateOfStart, endDate: dateOfEnd },
                    success: function (response) {
                        eval(response);
                    }
                });
            });

        });
    </script>
}

<div class="card">
    <div class="card-body">
        <h4 class="card-title">Araç Talebi Raporları</h4>
        <hr />
        <div class="row mb-2">
            <div class="col-md-4 row">
                <label for="DateRangeFilter" class="col-sm-4 col-form-label pt-0 bold">Başlama Tarihi</label>
                <div class="col-lg-8 col-md-8 col-sm-7">
                    <input type="datetime-local" id="DateOfStart" class="form-control" style="width: 100%;" />
                </div>
            </div>
            <div class="col-4 row">
                <label for="DateRangeFilter" class="col-sm-4 col-form-label pt-0 bold">Bitiş Tarihi</label>
                <div class="col-lg-8 col-md-8 col-sm-7">
                    <input type="datetime-local" id="DateOfEnd" class="form-control" style="width: 100%;" />
                </div>
            </div>
            <div class="col-2">
                <button id="Listing" class="btn btn-primary mb-4">Listele</button>
            </div>
            <div class="col-2">
                <button id="ExportExcel" class="btn btn-success mb-4">Excel Çıktısı Al</button>
            </div>

        </div>
        <hr />
        <div class="table-responsive">
            <table class="table dataTable table-striped table-hover">
                <thead>
                    <tr>
                        <th>Plaka</th>
                        <th>Çalışan</th>
                        <th>Talep Tipi</th>
                        <th>Başlangıç Tarihi</th>
                        <th>Bitiş Tarihi</th>
                        <th>Gidiş/Dönüş</th>
                        <th>Açıklama</th>
                        <th class="text-center">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.VehicleRequests.Count != 0)
                    {
                        @foreach (VehicleRequestDto item in Model.VehicleRequests)
                        {
                            <tr id="@item.Id.ToString()">
                                <td>@item.Vehicle.Plate</td>
                                <td>@(item.Mission != null ? item.Mission.Employee.Name + " " + @item.Mission.Employee.Surname : "Çalışana Atanmamış")</td>
                                <td>Görev</td>
                                <td>@item.DateOfStart.ToString("dd MMMM yyyy HH:mm")</td>
                                <td>@item.DateOfEnd.ToString("dd MMMM yyyy HH:mm")</td>
                                <td>
                                    @(item.IsGoing ? "Gidiş" : "Dönüş")
                                </td>
                                <td>
                                    @item.Description
                                </td>
                                <td>
                                    <a onclick="AjaxMethod('VehicleRequest/ExportDocument', '@item.Id.ToString()', 'Print')" href=""><i class="mdi mdi-printer text-warning md20"></i></a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

        </div>
    </div>
</div>

